/*! pager.js - v0.5.0 - 2012-10-03
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
define(["jquery","underscore","knockout"],function(a,b,c){var d={};d.page=null,d.now=function(){return Date.now?Date.now():(new Date).valueOf()},d.extendWithPage=function(a){var b=new d.Page;a.$__page__=b,d.page=b},d.navigationFailed=c.observable(),d.showChild=function(a){d.page.childManager.showChild(a)};var e={};e.value=c.utils.unwrapObservable,e.arrayValue=function(a){return b.map(a,function(a){return e.value(a)})};var f=function(a){var b,c={},d=/\+/g,e=/([^&=]+)=?([^&]*)/g,f=function(a){return decodeURIComponent(a.replace(d," "))};while(b=e.exec(a))c[f(b[1])]=f(b[2]);return c},g=function(a){if(!a)return{name:null,params:{}};var b=a.split("?"),c=b[0],d=b[1],e={};return d&&(e=f(d)),{name:c,params:e}};d.ChildManager=function(a,f){this.currentChildO=c.observable(null);var h=this;this.page=f,this.timeStamp=d.now(),this.hideChild=function(){h.currentChild&&h.currentChild.getId()!=="start"&&(h.currentChild.hidePage(function(){}),h.currentChild=null,h.currentChildO(null))},this.showChild=function(c){this.timeStamp=d.now();var f=this.timeStamp,i=h.currentChild;h.currentChild=null;var j=!1,k=g(c[0]),l=k.name,m=null;b.each(a(),function(a){if(!j){var b=a.getId();if(b===l||(l===""||l==null)&&b==="start")j=!0,h.currentChild=a;b==="?"&&(m=a)}});var n=!1,o=h,p=function(a){if(!j){var b=a.getId(),c=a.getValue().modal;if(c){if(b===l||(l===""||l==null)&&b==="start")j=!0,h.currentChild=a,n=!0;b==="?"&&!m&&(m=a,n=!0)}}};while(!h.currentChild&&o.page.parentPage&&!o.page.getValue().modal){var q=o.page.parentPage.children;b.each(q(),p),h.currentChild||(o=o.page.parentPage.childManager)}!h.currentChild&&m&&(h.currentChild=m,h.currentChild.currentId=l),h.currentChild&&(h.currentChildO(h.currentChild),n?h.currentChild.currentParentPage(h.page):h.currentChild.currentParentPage(null));var r=function(){d.navigationFailed&&d.navigationFailed({page:h.page,route:c}),h.page.getValue().navigationFailed&&e.value(h.page.getValue().navigationFailed)(h.page,c)},s=function(){var a=e.value(h.currentChild.getValue().guard);a?a(h.currentChild,c,function(){h.timeStamp===f&&h.currentChild.showPage(c.slice(1),k,c[0])},i):h.currentChild.showPage(c.slice(1),k,c[0])};i&&i===h.currentChild?s():i?i.hidePage(function(){h.currentChild?s():r()}):h.currentChild?s():r()}};var h;d.Page=function(a,b,e,f,g){this.element=a,this.valueAccessor=b,this.allBindingsAccessor=e,this.viewModel=f,this.bindingContext=g,this.children=c.observableArray([]),this.childManager=new d.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.ctx=null,this.currentParentPage=c.observable(null),this.isVisible=c.observable(!1),this.originalRoute=c.observable(null),this.route=null};var i=d.Page.prototype;i.val=function(a){return e.value(this.getValue()[a])},i.currentChildPage=function(){return this.childManager.currentChildO},i.showPage=function(a,b,c){this.isVisible(!0),this.originalRoute(c),this.route=a,this.pageRoute=b,this.setParams(),this.show(),this.childManager.showChild(a)},i.setParams=function(){if(this.pageRoute&&this.pageRoute.params){var d=this.pageRoute.params,e=this.ctx,f=this.val("params")||{};a.each(d,function(a,d){b.indexOf(f,a)!==-1&&(e[a]?e[a](d):e[a]=c.observable(d))})}},i.hidePage=function(a){this.isVisible(!1),this.hideElementWrapper(a),this.childManager.hideChild()},i.init=function(){var a=this,b=a.getValue();return a.parentPage=a.getParentPage(),a.parentPage.children.push(this),a.hideElement(),a.val("source")&&a.loadSource(a.val("source")),a.ctx=null,b["with"]?(a.ctx=e.value(b["with"]),a.augmentContext()):b.withOnShow?a.ctx={}:(a.ctx=a.viewModel,a.augmentContext()),a.childBindingContext=a.bindingContext.createChildContext(a.ctx),c.utils.extend(a.childBindingContext,{$page:this}),a.val("withOnShow")||c.applyBindingsToDescendants(a.childBindingContext,a.element),{controlsDescendantBindings:!0}},i.augmentContext=function(){var b=this;b.val("params")&&a.each(this.val("params"),function(a,d){b.ctx[d]||(b.ctx[d]=c.observable())}),this.val("vars")&&a.each(this.val("vars"),function(a,d){b.ctx[a]=c.observable(d)}),this.setParams()},i.getValue=function(){return this.valueAccessor?e.value(this.valueAccessor()):{}},i.getParentPage=function(){var a=this.bindingContext;while(a){if(a.$page)return a.$page;if(a.$data&&a.$data.$__page__)return a.$data.$__page__;a=a.$parentContext}return null},i.getId=function(){return this.val("id")},i.sourceUrl=function(a){var b=this;return this.getId()==="?"?c.computed(function(){var c;return b.val("deep")?c=b.getFullRoute()().concat(b.route).join("/"):c=b.currentId,e.value(a).replace("{1}",c)}):c.computed(function(){return e.value(a)})},i.loadSource=function(b){var f=this.getValue(),g=this,h=this.element,i=null,j=f.loader||d.loader;if(f.frame==="iframe"){var k=a("iframe",a(h));k.length===0&&(k=a("<iframe></iframe>"),a(h).append(k)),j&&(i=e.value(j)(g,k),i.load()),f.sourceLoaded&&k.one("load",function(){i&&i.unload(),f.sourceLoaded(g)}),c.applyBindingsToNode(k[0],{attr:{src:this.sourceUrl(b)}})}else j&&(i=e.value(j)(g,g.element),i.load()),c.computed(function(){var d=function(){i&&i.unload(),c.applyBindingsToDescendants(g.childBindingContext,g.element),f.sourceLoaded&&f.sourceLoaded(g),g.route&&g.childManager.showChild(g.route)};if(typeof e.value(b)=="string"){var j=e.value(this.sourceUrl(b));a(h).load(j,function(){d()})}else e.value(b)(this,function(){d()})},this)},i.show=function(a){var e=this.element,f=this;f.showElementWrapper(a),f.val("title")&&(window.document.title=f.val("title")),f.val("withOnShow")&&(!f.withOnShowLoaded||f.val("sourceCache")!==!0)&&(f.withOnShowLoaded=!0,f.val("withOnShow")(b.bind(function(a){var b=f.bindingContext.createChildContext(a);f.ctx=a,f.augmentContext(),c.utils.extend(b,{$page:this}),c.applyBindingsToDescendants(b,f.element)},this),this)),f.val("sourceOnShow")&&(!f.val("sourceCache")||!e.__pagerLoaded__||typeof f.val("sourceCache")=="number"&&e.__pagerLoaded__+f.val("sourceCache")*1e3<d.now())&&(e.__pagerLoaded__=d.now(),f.loadSource(f.val("sourceOnShow")))},i.showElementWrapper=function(a){this.val("beforeShow")&&this.val("beforeShow")(this),this.showElement(a),this.val("afterShow")&&this.val("afterShow")(this)},i.showElement=function(b){this.val("showElement")?this.val("showElement")(this,b):this.val("fx")?d.fx[this.val("fx")].showElement(this,b):d.showElement?d.showElement(this,b):a(this.element).show(b)},d.Page.prototype.hideElementWrapper=function(a){this.val("beforeHide")&&this.val("beforeHide")(this),this.hideElement(a),this.val("afterHide")&&this.val("afterHide")(this)},i.hideElement=function(b){this.val("hideElement")?this.val("hideElement")(this,b):this.val("fx")?d.fx[this.val("fx")].hideElement(this,b):d.hideElement?d.hideElement(this,b):(a(this.element).hide(),b&&b())},i.getFullRoute=function(){return c.computed(function(){var a=null;return this.currentParentPage&&this.currentParentPage()?(a=this.currentParentPage().getFullRoute()(),a.push(this.originalRoute()||this.getId()),a):this.parentPage?(a=this.parentPage.getFullRoute()(),a.push(this.originalRoute()||this.getId()),a):[]},this)},i.nullObject=new d.Page,i.nullObject.children=c.observableArray([]),i.child=function(a){return c.computed(function(){var c=b.find(this.children(),function(b){return b.getId()===a});return c||this.nullObject},this)},c.bindingHandlers.page={init:function(a,b,c,e,f){var g=new d.Page(a,b,c,e,f);return g.init()},update:function(){}},d.useHTML5history=!1,d.rootURI="/",d.Href=function(a,b,d,e,f){this.element=a,this.valueAccessor=b,this.allBindingsAccessor=d,this.viewModel=e,this.bindingContext=f,this.path=c.observable(),this.val=c.observable(b)};var j=d.Href.prototype;return j.getParentPage=i.getParentPage,j.init=function(){var a=this.getParentPage();this.path=c.computed(function(){var b=e.value(this.val()());if(typeof b=="string"){var c=0;while(b.substring(0,3)==="../")c++,b=b.slice(3);var d=a.getFullRoute()(),f=d.slice(0,d.length-c).join("/"),g=(f===""?"":f+"/")+b;return g}return b.getFullRoute?b.getFullRoute()().join("/"):""},this)},d.Href.hash="#",j.bind=function(){var a=c.computed(function(){return d.Href.hash+this.path()},this);c.applyBindingsToNode(this.element,{attr:{href:a}})},j.update=function(a){this.val(a)},d.Href5=function(a,b,c,e,f){d.Href.apply(this,arguments)},d.Href5.prototype=new d.Href,d.Href5.history=window.history,d.Href5.prototype.bind=function(){c.applyBindingsToNode(this.element,{attr:{href:this.path},click:b.bind(function(){d.Href5.history.pushState(null,null,this.path())},this)})},c.bindingHandlers["page-hash"]={init:function(a,b,c,e,f){var g=new d.Href(a,b,c,e,f);g.init(),g.bind(),a.__ko__page=g},update:function(a,b){a.__ko__page.update(b)}},c.bindingHandlers["page-href5"]={init:function(a,b,c,e,f){var g=new d.Href5(a,b,c,e,f);g.init(),g.bind(),a.__ko__page=g},update:function(a,b){a.__ko__page.update(b)}},c.bindingHandlers["page-href"]={init:function(a,b,c,e,f){var g=d.useHTML5history?d.Href5:d.Href,h=new g(a,b,c,e,f);h.init(),h.bind(),a.__ko__page=h},update:function(a,b){a.__ko__page.update(b)}},d.fx={},d.fx.zoom={showElement:function(b,c){a(b.element).addClass("pagerjs-fx-zoom"),a(b.element).show();var d=setInterval(function(){clearInterval(d),a(b.element).addClass("pagerjs-fx-zoom-in")},10),e=setInterval(function(){clearInterval(e),c&&c()},300)},hideElement:function(b,c){if(!b.pageHiddenOnce)b.pageHiddenOnce=!0,a(b.element).hide();else{a(b.element).removeClass("pagerjs-fx-zoom-in");var d=setInterval(function(){clearInterval(d),c&&c(),a(b.element).hide()},300)}}},d.fx.flip={showElement:function(b,c){a(b.element).addClass("pagerjs-fx-flip"),a(b.element).show();var d=setInterval(function(){clearInterval(d),a(b.element).addClass("pagerjs-fx-flip-in")},10),e=setInterval(function(){clearInterval(e),c&&c()},300)},hideElement:function(b,c){if(!b.pageHiddenOnce)b.pageHiddenOnce=!0,a(b.element).hide();else{a(b.element).removeClass("pagerjs-fx-flip-in");var d=setInterval(function(){clearInterval(d),c&&c(),a(b.element).hide()},300)}}},d.fx.slide={showElement:function(b,c){a(b.element).slideDown(300,c)},hideElement:function(b,c){a(b.element).slideUp(300,function(){a(b.element).hide()}),c&&c()}},d.fx.fade={showElement:function(b,c){a(b.element).fadeIn(300,c)},hideElement:function(b,c){a(b.element).fadeOut(300,function(){a(b.element).hide(),c&&c()})}},d.routeFromHashToPage=function(a){a.substring(0,d.Href.hash.length)===d.Href.hash&&(a=a.slice(d.Href.hash.length));var b=decodeURIComponent(a).split("/");d.showChild(b)},d.start=function(){var b=function(){d.routeFromHashToPage(window.location.hash)};a(window).bind("hashchange",b),b()},d});