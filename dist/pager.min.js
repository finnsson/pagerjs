/*! pager.js - v0.7.0 - 2012-11-03
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
(function(e){var t=e.History,n=function(n,r){"use strict";var i={};i.page=null,i.now=function(){return Date.now?Date.now():(new Date).valueOf()},i.extendWithPage=function(e){var t=new i.Page;e.$__page__=t,i.page=t},i.navigationFailed=r.observable(),i.showChild=function(e){i.page.showPage(e)};var s={};s.value=r.utils.unwrapObservable,s.arrayValue=function(e){return n.map(e,function(e){return s.value(e)})};var o=function(e){var t,n={},r=/\+/g,i=/([^&=]+)=?([^&]*)/g,s=function(e){return decodeURIComponent(e.replace(r," "))};while(t=i.exec(e))n[s(t[1])]=s(t[2]);return n},u=function(e){if(!e)return{name:null,params:{}};var t=e.split("?"),n=t[0],r=t[1],i={};return r&&(i=o(r)),{name:n,params:i}};i.ChildManager=function(e,t){this.currentChildO=r.observable(null);var o=this;this.page=t,this.timeStamp=i.now(),this.hideChild=function(){o.currentChild&&o.currentChild.getId()!=="start"&&(o.currentChild.hidePage(function(){}),o.currentChild=null,o.currentChildO(null))},this.showChild=function(t){this.timeStamp=i.now();var r=this.timeStamp,a=o.currentChild;o.currentChild=null;var f=!1,l=u(t[0]),c=l.name,h=null;n.each(e(),function(e,t){if(!f){var n=t.getId();if(n===c||(c===""||c==null)&&n==="start")f=!0,o.currentChild=t;n==="?"&&(h=t)}});var p=!1,d=o,v=function(e,t){if(!f){var n=t.getId(),r=t.getValue().modal;if(r){if(n===c||(c===""||c==null)&&n==="start")f=!0,o.currentChild=t,p=!0;n==="?"&&!h&&(h=t,p=!0)}}};while(!o.currentChild&&d.page.parentPage&&!d.page.getValue().modal){var m=d.page.parentPage.children;n.each(m(),v),o.currentChild||(d=d.page.parentPage.childManager)}!o.currentChild&&h&&(o.currentChild=h),o.currentChild&&(o.currentChildO(o.currentChild),p?o.currentChild.currentParentPage(o.page):o.currentChild.currentParentPage(null));var g=function(){i.navigationFailed&&i.navigationFailed({page:o.page,route:t}),o.page.getValue().navigationFailed&&s.value(o.page.getValue().navigationFailed)(o.page,t)},y=function(){var e=s.value(o.currentChild.getValue().guard);e?e(o.currentChild,t,function(){o.timeStamp===r&&o.currentChild.showPage(t.slice(1),l,t[0])},a):o.currentChild.showPage(t.slice(1),l,t[0])};a&&a===o.currentChild?y():a?a.hidePage(function(){o.currentChild?y():g()}):o.currentChild?y():g()}},i.Page=function(e,t,n,s,o){this.element=e,this.valueAccessor=t,this.allBindingsAccessor=n,this.viewModel=s,this.bindingContext=o,this.children=r.observableArray([]),this.childManager=new i.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.ctx=null,this.currentParentPage=r.observable(null),this.isVisible=r.observable(!1),this.originalRoute=r.observable(null),this.route=null};var a=i.Page.prototype;a.val=function(e){return s.value(this.getValue()[e])},a.currentChildPage=function(){return this.childManager.currentChildO},a.showPage=function(e,t,n){var r=this,i=r.currentId,s=r.pageRoute?r.pageRoute.params:null,o=r.isVisible();r.currentId=t?t.name:null,r.isVisible(!0),r.originalRoute(n),r.route=e,r.pageRoute=t,o?(r.getId()==="?"&&i!==r.currentId&&r.show(),t&&s!==t.params&&r.setParams()):(r.setParams(),r.show()),r.childManager.showChild(e)},a.setParams=function(){if(this.pageRoute&&this.pageRoute.params){var e=this.pageRoute.params,t=this.ctx,i=this.val("params")||{};n.each(e,function(e,s){n.inArray(e,i)!==-1&&(t[e]?t[e](s):t[e]=r.observable(s))})}if(this.pageRoute){var s=this.getValue().nameParam;s&&(typeof s=="string"?this.ctx[s]?this.ctx[s](this.currentId):this.ctx[s]=r.observable(this.currentId):s(this.currentId))}},a.hidePage=function(e){this.isVisible(!1),this.hideElementWrapper(e),this.childManager.hideChild()},a.init=function(){var e=this;r.utils.domNodeDisposal.addDisposeCallback(e.element,function(){e.parentPage.children.remove(e)});var t=e.getValue();return e.parentPage=e.getParentPage(),e.parentPage.children.push(this),e.hideElement(),e.val("source")&&e.loadSource(e.val("source")),e.ctx=null,t["with"]?(e.ctx=s.value(t["with"]),e.augmentContext()):t.withOnShow?e.ctx={}:(e.ctx=e.viewModel,e.augmentContext()),e.childBindingContext=e.bindingContext.createChildContext(e.ctx),r.utils.extend(e.childBindingContext,{$page:this}),e.val("withOnShow")||r.applyBindingsToDescendants(e.childBindingContext,e.element),e.parentPage.route&&e.parentPage.route[0]===e.getId()&&setTimeout(function(){e.parentPage.showPage(e.parentPage.route)},0),{controlsDescendantBindings:!0}},a.augmentContext=function(){var e=this;e.val("params")&&n.each(this.val("params"),function(t,n){e.ctx[n]||(e.ctx[n]=r.observable())}),this.val("vars")&&n.each(this.val("vars"),function(t,n){e.ctx[t]=r.observable(n)}),this.setParams()},a.getValue=function(){return this.valueAccessor?s.value(this.valueAccessor()):{}},a.getParentPage=function(){var e=this.bindingContext;while(e){if(e.$page)return e.$page;if(e.$data&&e.$data.$__page__)return e.$data.$__page__;e=e.$parentContext}return null},a.getId=function(){return this.val("id")},a.sourceUrl=function(e){var t=this;return this.getId()==="?"?r.computed(function(){var n;return t.val("deep")?n=[t.currentId].concat(t.route).join("/"):n=t.currentId,s.value(e).replace("{1}",n)}):r.computed(function(){return s.value(e)})},a.loadSource=function(e){var t=this.getValue(),o=this,u=this.element,a=null,f=t.loader||i.loader;if(t.frame==="iframe"){var l=n("iframe",n(u));l.length===0&&(l=n("<iframe></iframe>"),n(u).append(l)),f&&(a=s.value(f)(o,l),a.load()),l.one("load",function(){a&&a.unload(),t.sourceLoaded&&t.sourceLoaded(o)}),r.applyBindingsToNode(l[0],{attr:{src:this.sourceUrl(e)}})}else f&&(a=s.value(f)(o,o.element),a.load()),r.computed(function(){var i=function(){a&&a.unload(),r.applyBindingsToDescendants(o.childBindingContext,o.element),t.sourceLoaded&&t.sourceLoaded(o),o.route&&o.childManager.showChild(o.route)};if(typeof s.value(e)=="string"){var f=s.value(this.sourceUrl(e));n(u).load(f,function(){i()})}else s.value(e)(this,function(){i()})},this)},a.show=function(t){var n=this.element,s=this;s.showElementWrapper(t),s.val("title")&&(e.document.title=s.val("title")),s.val("withOnShow")&&(!s.withOnShowLoaded||s.val("sourceCache")!==!0)&&(s.withOnShowLoaded=!0,s.val("withOnShow")(function(e){var t=s.bindingContext.createChildContext(e);s.ctx=e,s.augmentContext(),r.utils.extend(t,{$page:s}),r.applyBindingsToDescendants(t,s.element)},s)),s.val("sourceOnShow")&&(!s.val("sourceCache")||!n.__pagerLoaded__||typeof s.val("sourceCache")=="number"&&n.__pagerLoaded__+s.val("sourceCache")*1e3<i.now())&&(n.__pagerLoaded__=i.now(),s.loadSource(s.val("sourceOnShow")))},a.showElementWrapper=function(e){this.val("beforeShow")&&this.val("beforeShow")(this),this.showElement(e),this.val("afterShow")&&this.val("afterShow")(this)},a.showElement=function(e){this.val("showElement")?this.val("showElement")(this,e):this.val("fx")?i.fx[this.val("fx")].showElement(this,e):i.showElement?i.showElement(this,e):n(this.element).show(e)},i.Page.prototype.hideElementWrapper=function(e){this.val("beforeHide")&&this.val("beforeHide")(this),this.hideElement(e),this.val("afterHide")&&this.val("afterHide")(this)},a.hideElement=function(e){this.val("hideElement")?this.val("hideElement")(this,e):this.val("fx")?i.fx[this.val("fx")].hideElement(this,e):i.hideElement?i.hideElement(this,e):(n(this.element).hide(),e&&e())},a.getFullRoute=function(){return r.computed(function(){var e=null;return this.currentParentPage&&this.currentParentPage()?(e=this.currentParentPage().getFullRoute()(),e.push(this.originalRoute()||this.getId()),e):this.parentPage?(e=this.parentPage.getFullRoute()(),e.push(this.originalRoute()||this.getId()),e):[]},this)},a.nullObject=new i.Page,a.nullObject.children=r.observableArray([]),a.child=function(e){return r.computed(function(){var t=n.grep(this.children(),function(t){return t.getId()===e})[0];return t||this.nullObject},this)},r.bindingHandlers.page={init:function(e,t,n,r,s){var o=new i.Page(e,t,n,r,s);return o.init()}},i.useHTML5history=!1,i.rootURI="/",i.Href=function(e,t,n,i,s){this.element=e,this.bindingContext=s,this.path=r.observable(),this.val=r.observable(t)};var f=i.Href.prototype;return f.getParentPage=a.getParentPage,f.init=function(){var e=this.getParentPage();this.path=r.computed(function(){var t=s.value(this.val()());if(typeof t=="string"){var n=0;while(t.substring(0,3)==="../")n++,t=t.slice(3);var r=e.getFullRoute()(),i=r.slice(0,r.length-n).join("/");return(i===""?"":i+"/")+t}return t.getFullRoute?t.getFullRoute()().join("/"):""},this)},i.Href.hash="#",f.bind=function(){var e=r.computed(function(){return i.Href.hash+this.path()},this);r.applyBindingsToNode(this.element,{attr:{href:e}})},f.update=function(e){this.val(e)},i.Href5=function(e,t,n,r,s){i.Href.apply(this,arguments)},i.Href5.prototype=new i.Href,i.Href5.history=e.history,i.Href5.prototype.bind=function(){var e=this;r.applyBindingsToNode(e.element,{attr:{href:e.path},click:function(){i.Href5.history.pushState(null,null,e.path())}})},r.bindingHandlers["page-hash"]={init:function(e,t,n,r,s){var o=new i.Href(e,t,n,r,s);o.init(),o.bind(),e.__ko__page=o},update:function(e,t){e.__ko__page.update(t)}},r.bindingHandlers["page-href5"]={init:function(e,t,n,r,s){var o=new i.Href5(e,t,n,r,s);o.init(),o.bind(),e.__ko__page=o},update:function(e,t){e.__ko__page.update(t)}},r.bindingHandlers["page-href"]={init:function(e,t,n,r,s){var o=i.useHTML5history?i.Href5:i.Href,u=new o(e,t,n,r,s);u.init(),u.bind(),e.__ko__page=u},update:function(e,t){e.__ko__page.update(t)}},i.fx={},i.fx.cssAsync=function(e){return{showElement:function(t,r){var i=n(t.element);i.addClass(e),i.show();var s=setInterval(function(){clearInterval(s),i.addClass(e+"-in")},10),o=setInterval(function(){clearInterval(o),r&&r()},300)},hideElement:function(t,r){var i=n(t.element);if(!t.pageHiddenOnce)t.pageHiddenOnce=!0,i.hide();else{i.removeClass(e+"-in");var s=setInterval(function(){clearInterval(s),r&&r(),i.hide()},300)}}}},i.fx.zoom=i.fx.cssAsync("pagerjs-fx-zoom"),i.fx.flip=i.fx.cssAsync("pagerjs-fx-flip"),i.fx.popout=i.fx.cssAsync("pagerjs-fx-popout-modal"),i.fx.jQuerySync=function(e,t){return{showElement:function(t,r){e.call(n(t.element),300,r)},hideElement:function(e,r){t.call(n(e.element),300,function(){n(e.element).hide()}),r&&r()}}},i.fx.slide=i.fx.jQuerySync(n.fn.slideDown,n.fn.slideUp),i.fx.fade=i.fx.jQuerySync(n.fn.fadeIn,n.fn.fadeOut),i.startHistoryJs=function(r){r&&t.pushState(null,null,r);var s=function(e){e.substring(0,i.Href.hash.length)===i.Href.hash&&(e=e.slice(i.Href.hash.length));var t=decodeURIComponent(e).split("/");i.showChild(t)};t.Adapter.bind(e,"statechange",function(){var e=n("base").attr("href"),r=t.getState().url.replace(e,"");s(r)}),t.Adapter.bind(e,"anchorchange",function(){s(location.hash)}),s(t.getState().url.replace(t.getRootUrl(),""))},i.startHashChange=function(t){t&&(location.hash=i.Href.hash+t),n(e).hashchange(function(){var e=location.hash;e.substring(0,i.Href.hash.length)===i.Href.hash&&(e=e.slice(i.Href.hash.length));var t=decodeURIComponent(e).split("/");i.showChild(t)}),n(e).hashchange()},i.start=function(t){t&&(location.hash=i.Href.hash+t);var r=function(e){e.substring(0,i.Href.hash.length)===i.Href.hash&&(e=e.slice(i.Href.hash.length));var t=decodeURIComponent(e).split("/");i.showChild(t)},s=function(){r(e.location.hash)};n(e).bind("hashchange",s),s()},i},r=e.define;typeof r=="function"&&typeof r.amd=="object"&&r.amd?r(["knockout","jquery"],function(e){return n($,e)}):e.pager=n($,ko)})(window);