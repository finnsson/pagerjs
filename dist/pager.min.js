/*! pager.js - v0.5.0 - 2012-10-03
* http://oscar.finnsson.nu/pagerjs/
* Copyright (c) 2012 Oscar Finnsson; Licensed MIT */
var pager={};pager.page=null,pager.now=function(){return Date.now?Date.now():(new Date).valueOf()},pager.extendWithPage=function(a){var b=new pager.Page;a.$__page__=b,pager.page=b},pager.navigationFailed=ko.observable(),pager.routeFromHashToPage=function(a){a[0]==="#"&&(a=a.slice(1));var b=decodeURIComponent(a).split("/");pager.showChild(b)},pager.showChild=function(a){pager.page.childManager.showChild(a)};var _ko={};_ko.value=ko.utils.unwrapObservable,_ko.arrayValue=function(a){return _.map(a,function(a){return _ko.value(a)})};var parseStringAsParameters=function(a){var b,c={},d=/\+/g,e=/([^&=]+)=?([^&]*)/g,f=function(a){return decodeURIComponent(a.replace(d," "))};while(b=e.exec(a))c[f(b[1])]=f(b[2]);return c},splitRoutePartIntoNameAndParameters=function(a){if(!a)return{name:null,params:{}};var b=a.split("?"),c=b[0],d=b[1],e={};return d&&(e=parseStringAsParameters(d)),{name:c,params:e}};pager.ChildManager=function(a,b){this.currentChildO=ko.observable(null);var c=this;this.page=b,this.timeStamp=pager.now(),this.hideChild=function(){c.currentChild&&c.currentChild.getId()!=="start"&&(c.currentChild.hidePage(function(){}),c.currentChild=null,c.currentChildO(null))},this.showChild=function(b){this.timeStamp=pager.now();var d=this.timeStamp,e=c.currentChild;c.currentChild=null;var f=!1,g=splitRoutePartIntoNameAndParameters(b[0]),h=g.name,i=null;_.each(a(),function(a){if(!f){var b=a.getId();if(b===h||(h===""||h==null)&&b==="start")f=!0,c.currentChild=a;b==="?"&&(i=a)}});var j=!1,k=c,l=function(a){if(!f){var b=a.getId(),d=a.getValue().modal;if(d){if(b===h||(h===""||h==null)&&b==="start")f=!0,c.currentChild=a,j=!0;b==="?"&&!i&&(i=a,j=!0)}}};while(!c.currentChild&&k.page.parentPage&&!k.page.getValue().modal){var m=k.page.parentPage.children;_.each(m(),l),c.currentChild||(k=k.page.parentPage.childManager)}!c.currentChild&&i&&(c.currentChild=i,c.currentChild.currentId=h),c.currentChild&&(c.currentChildO(c.currentChild),j?c.currentChild.currentParentPage(c.page):c.currentChild.currentParentPage(null));var n=function(){pager.navigationFailed&&pager.navigationFailed({page:c.page,route:b}),c.page.getValue().navigationFailed&&_ko.value(c.page.getValue().navigationFailed)(c.page,b)},o=function(){var a=_ko.value(c.currentChild.getValue().guard);a?a(c.currentChild,b,function(){c.timeStamp===d&&c.currentChild.showPage(b.slice(1),g,b[0])},e):c.currentChild.showPage(b.slice(1),g,b[0])};e&&e===c.currentChild?o():e?e.hidePage(function(){c.currentChild?o():n()}):c.currentChild?o():n()}};var PageConfig;pager.Page=function(a,b,c,d,e){this.element=a,this.valueAccessor=b,this.allBindingsAccessor=c,this.viewModel=d,this.bindingContext=e,this.children=ko.observableArray([]),this.childManager=new pager.ChildManager(this.children,this),this.parentPage=null,this.currentId=null,this.ctx=null,this.currentParentPage=ko.observable(null),this.isVisible=ko.observable(!1),this.originalRoute=ko.observable(null),this.route=null};var p=pager.Page.prototype;p.val=function(a){return _ko.value(this.getValue()[a])},p.currentChildPage=function(){return this.childManager.currentChildO},p.showPage=function(a,b,c){this.isVisible(!0),this.originalRoute(c),this.route=a,b&&b.params&&this.setParams(b.params),this.show(),this.childManager.showChild(a)},p.setParams=function(a){var b=this.ctx,c=this.val("params")||{};$.each(a,function(a,d){_.indexOf(c,a)!==-1&&(b[a]?b[a](d):b[a]=ko.observable(d))})},p.hidePage=function(a){this.isVisible(!1),this.hideElementWrapper(a),this.childManager.hideChild()},p.init=function(){var a=this,b=this.getValue();return this.parentPage=this.getParentPage(),this.parentPage.children.push(this),this.hideElement(),this.val("source")&&this.loadSource(this.val("source")),this.ctx=null,b["with"]?this.ctx=_ko.value(b["with"]):b.withOnShow?this.ctx={}:this.ctx=this.viewModel,this.val("params")&&$.each(this.val("params"),function(b,c){a.ctx[c]||(a.ctx[c]=ko.observable())}),this.childBindingContext=this.bindingContext.createChildContext(this.ctx),ko.utils.extend(this.childBindingContext,{$page:this}),this.val("withOnShow")||ko.applyBindingsToDescendants(this.childBindingContext,this.element),{controlsDescendantBindings:!0}},p.getValue=function(){return this.valueAccessor?_ko.value(this.valueAccessor()):{}},p.getParentPage=function(){var a=this.bindingContext;while(a){if(a.$page)return a.$page;if(a.$data&&a.$data.$__page__)return a.$data.$__page__;a=a.$parentContext}return null},p.getId=function(){return this.val("id")},p.sourceUrl=function(a){var b=this;return this.getId()==="?"?ko.computed(function(){return _ko.value(a).replace("{1}",b.currentId)}):ko.computed(function(){return _ko.value(a)})},p.loadSource=function(a){var b=this.getValue(),c=this,d=this.element,e=null,f=b.loader||pager.loader;if(b.frame==="iframe"){var g=$("iframe",$(d));g.length===0&&(g=$("<iframe></iframe>"),$(d).append(g)),f&&(e=_ko.value(f)(c,g),e.load()),b.sourceLoaded&&g.one("load",function(){e&&e.unload(),b.sourceLoaded(c)}),ko.applyBindingsToNode(g[0],{attr:{src:this.sourceUrl(a)}})}else f&&(e=_ko.value(f)(c,c.element),e.load()),ko.computed(function(){var f=function(){e&&e.unload(),ko.applyBindingsToDescendants(c.childBindingContext,c.element),b.sourceLoaded&&b.sourceLoaded(c),c.route&&c.childManager.showChild(c.route)};if(typeof _ko.value(a)=="string"){var g=_ko.value(this.sourceUrl(a));$(d).load(g,function(){f()})}else _ko.value(a)(this,function(){f()})},this)},p.show=function(a){var b=this.element,c=this;c.showElementWrapper(a),c.val("title")&&(window.document.title=c.val("title")),c.val("withOnShow")&&(!c.withOnShowLoaded||c.val("sourceCache")!==!0)&&(c.withOnShowLoaded=!0,c.val("withOnShow")(_.bind(function(a){var b=c.bindingContext.createChildContext(a);c.ctx=a,ko.utils.extend(b,{$page:this}),ko.applyBindingsToDescendants(b,c.element)},this),this)),c.val("sourceOnShow")&&(!c.val("sourceCache")||!b.__pagerLoaded__||typeof c.val("sourceCache")=="number"&&b.__pagerLoaded__+c.val("sourceCache")*1e3<pager.now())&&(b.__pagerLoaded__=pager.now(),c.loadSource(c.val("sourceOnShow")))},p.showElementWrapper=function(a){this.val("beforeShow")&&this.val("beforeShow")(this),this.showElement(a),this.val("afterShow")&&this.val("afterShow")(this)},p.showElement=function(a){this.val("showElement")?this.val("showElement")(this,a):this.val("fx")?pager.fx[this.val("fx")].showElement(this,a):pager.showElement?pager.showElement(this,a):$(this.element).show(a)},pager.Page.prototype.hideElementWrapper=function(a){this.val("beforeHide")&&this.val("beforeHide")(this),this.hideElement(a),this.val("afterHide")&&this.val("afterHide")(this)},p.hideElement=function(a){this.val("hideElement")?this.val("hideElement")(this,a):this.val("fx")?pager.fx[this.val("fx")].hideElement(this,a):pager.hideElement?pager.hideElement(this,a):($(this.element).hide(),a&&a())},p.getFullRoute=function(){return ko.computed(function(){var a=null;return this.currentParentPage&&this.currentParentPage()?(a=this.currentParentPage().getFullRoute()(),a.push(this.originalRoute()||this.getId()),a):this.parentPage?(a=this.parentPage.getFullRoute()(),a.push(this.originalRoute()||this.getId()),a):[]},this)},p.nullObject=new pager.Page,p.child=function(a){return ko.computed(function(){var b=_.find(this.children(),function(b){return b.getId()===a});return b||this.nullObject},this)},ko.bindingHandlers.page={init:function(a,b,c,d,e){var f=new pager.Page(a,b,c,d,e);return f.init()},update:function(){}},pager.useHTML5history=!1,pager.rootURI="/",pager.Href=function(a,b,c,d,e){this.element=a,this.valueAccessor=b,this.allBindingsAccessor=c,this.viewModel=d,this.bindingContext=e};var hp=pager.Href.prototype;hp.getParentPage=p.getParentPage,hp.init=function(){var a=this.getParentPage();this.path=ko.computed(function(){var b=_ko.value(this.valueAccessor()),c=0;while(b.substring(0,3)==="../")c++,b=b.slice(3);var d=a.getFullRoute()(),e=d.slice(0,d.length-c).join("/"),f=(e===""?"":e+"/")+b;return f},this)},hp.bind=function(){var a=ko.computed(function(){return"#"+this.path()},this);ko.applyBindingsToNode(this.element,{attr:{href:a}})},pager.Href5=function(a,b,c,d,e){pager.Href.apply(this,arguments)},pager.Href5.prototype=new pager.Href,pager.Href5.history=window.history,pager.Href5.prototype.bind=function(){ko.applyBindingsToNode(this.element,{attr:{href:this.path},click:_.bind(function(){pager.Href5.history.pushState(null,null,this.path())},this)})},ko.bindingHandlers["page-hash"]={init:function(a,b,c,d,e){var f=new pager.Href(a,b,c,d,e);f.init(),f.bind()},update:function(){}},ko.bindingHandlers["page-href5"]={init:function(a,b,c,d,e){var f=new pager.Href5(a,b,c,d,e);f.init(),f.bind()},update:function(){}},ko.bindingHandlers["page-href"]={init:function(a,b,c,d,e){var f=pager.useHTML5history?pager.Href5:pager.Href,g=new f(a,b,c,d,e);g.init(),g.bind()},update:function(){}},pager.fx={},pager.fx.zoom={showElement:function(a,b){$(a.element).addClass("pagerjs-fx-zoom"),$(a.element).show();var c=setInterval(function(){clearInterval(c),$(a.element).addClass("pagerjs-fx-zoom-in")},10),d=setInterval(function(){clearInterval(d),b&&b()},300)},hideElement:function(a,b){if(!a.pageHiddenOnce)a.pageHiddenOnce=!0,$(a.element).hide();else{$(a.element).removeClass("pagerjs-fx-zoom-in");var c=setInterval(function(){clearInterval(c),b&&b(),$(a.element).hide()},300)}}},pager.fx.flip={showElement:function(a,b){$(a.element).addClass("pagerjs-fx-flip"),$(a.element).show();var c=setInterval(function(){clearInterval(c),$(a.element).addClass("pagerjs-fx-flip-in")},10),d=setInterval(function(){clearInterval(d),b&&b()},300)},hideElement:function(a,b){if(!a.pageHiddenOnce)a.pageHiddenOnce=!0,$(a.element).hide();else{$(a.element).removeClass("pagerjs-fx-flip-in");var c=setInterval(function(){clearInterval(c),b&&b(),$(a.element).hide()},300)}}},pager.fx.slide={showElement:function(a,b){$(a.element).slideDown(300,b)},hideElement:function(a,b){$(a.element).slideUp(300,function(){$(a.element).hide()}),b&&b()}},pager.fx.fade={showElement:function(a,b){$(a.element).fadeIn(300,b)},hideElement:function(a,b){$(a.element).fadeOut(300,function(){$(a.element).hide(),b&&b()})}},pager.start=function(){var a=function(){pager.routeFromHashToPage(window.location.hash)};$(window).bind("hashchange",a),a()};